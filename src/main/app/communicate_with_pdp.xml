<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:ftp="http://www.mulesoft.org/schema/mule/ee/ftp" xmlns:tracking="http://www.mulesoft.org/schema/mule/ee/tracking" xmlns:ws="http://www.mulesoft.org/schema/mule/ws"
	xmlns:mulexml="http://www.mulesoft.org/schema/mule/xml"
	xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:spring="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/ws http://www.mulesoft.org/schema/mule/ws/current/mule-ws.xsd
http://www.mulesoft.org/schema/mule/xml http://www.mulesoft.org/schema/mule/xml/current/mule-xml.xsd
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/tracking http://www.mulesoft.org/schema/mule/ee/tracking/current/mule-tracking-ee.xsd
http://www.mulesoft.org/schema/mule/ee/ftp http://www.mulesoft.org/schema/mule/ee/ftp/current/mule-ftp-ee.xsd">
    <sub-flow name="communicate_with_pdp_sf">
                <dw:transform-message doc:name="Transform Aux">
                    <dw:set-variable variableName="aux"><![CDATA[%dw 1.0
%output application/xml
%namespace soapenv http://schemas.xmlsoap.org/soap/envelope/
%var action=sessionVars.action
%var from=sessionVars.from
%var source=payload.soapenv#Envelope.soapenv#Body.Persona.Source
%var target=payload.soapenv#Envelope.soapenv#Body.Persona.Target
---
{
    Request @(
        xmlns: "urn:oasis:names:tc:xacml:3.0:core:schema:wd-17",
        ReturnPolicyIdList: "false",
        CombinedDecision: "false"): {
	      Attributes @(
	            Category: "urn:oasis:names:tc:xacml:3.0:attribute-category:action"): {
	              Attribute @(
	                IncludeInResult: "false",
	                AttributeId: "urn:oasis:names:tc:xacml:1.0:action:action-id"): {
	                  AttributeValue @(
	                    DataType: "http://www.w3.org/2001/XMLSchema#string"): sessionVars.action
	                }
	            },
          Attributes @(
            Category: "urn:oasis:names:tc:xacml:1.0:subject-category:access-subject"): {
              Attribute @(
                IncludeInResult: "false",
                AttributeId: "urn:oasis:names:tc:xacml:1.0:subject:subject-id"): {
                  AttributeValue @(
                    DataType: "http://www.w3.org/2001/XMLSchema#string"): sessionVars.from
                }
            },
          Attributes @(
            Category: "urn:oasis:names:tc:xacml:3.0:attribute-category:resource"): 
            	
              (	source mapObject {
			      Attribute @(
			        IncludeInResult: "false",
			        AttributeId: "urn:oasis:names:tc:xacml:1.0:resource:" ++ $$):  {
			          AttributeValue @(
			            DataType: "http://www.w3.org/2001/XMLSchema#string"): $
			        }
			     }
		      ) ++
              (	target mapObject {
	              Attribute @(
	                IncludeInResult: "false",
	                AttributeId: "urn:oasis:names:tc:xacml:1.0:resource:Target"):  {
	                  AttributeValue @(
	                    DataType: "http://www.w3.org/2001/XMLSchema#string"): $$
	                }
	         	 }
              )
        }
}]]></dw:set-variable>
                </dw:transform-message>
                <logger message="Payload transformed: #[flowVars.aux]" level="INFO" doc:name="Logger"/>
        <dw:transform-message doc:name="Get Source and Target">
            <dw:set-variable variableName="sourceTarget"><![CDATA[%dw 1.0
%input payload application/xml
%output application/json
%namespace soapenv http://schemas.xmlsoap.org/soap/envelope/
%var source=payload.soapenv#Envelope.soapenv#Body.Persona.Source
%var target=payload.soapenv#Envelope.soapenv#Body.Persona.Target
---
{ 
	Source: { (source.TipoDocumento): source.NumeroDocumento },
	Target: target pluck $$
}]]></dw:set-variable>
        </dw:transform-message>
        <logger message="This is the Source Target #[flowVars.sourceTarget]" level="INFO" doc:name="Logger"/>
                <mulexml:xslt-transformer xsl-file="${path_project}/esb_mule/src/main/resources/temp.xsl" maxIdleTransformers="2" maxActiveTransformers="5" transformerFactoryClass="org.apache.xalan.processor.TransformerFactoryImpl" doc:name="XSLT for CDATA">
                    <mulexml:context-property key="xmlValue" value="#[flowVars.aux]"/>
                </mulexml:xslt-transformer>
                <logger message="Payload after XSLT: #[message.payload]" level="INFO" doc:name="Payload after XSLT"/>
                <ws:consumer config-ref="WebServicePDP" operation="getDecision" doc:name="Web Service PDP"/>
    </sub-flow>
</mule>
